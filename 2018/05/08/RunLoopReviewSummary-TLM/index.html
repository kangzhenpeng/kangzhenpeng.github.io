<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€åªè¿›æ¿€çš„å¤§ç™½å…”ã€‚"><title>RunLoopå›é¡¾æ€»ç»“ä¹‹ Thread-Loop Store | (â—â€”â—)ğŸ°Dash</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-118883756-1','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RunLoopå›é¡¾æ€»ç»“ä¹‹ Thread-Loop Store</h1><a id="logo" href="/.">(â—â€”â—)ğŸ°Dash</a><p class="description">(â—â€”â—)åšäººåšäº‹ï¼Œèµ¢åœ¨æ ¼å±€ï¼Œè¾“åœ¨è®¡è¾ƒï¼ï¼ï¼ğŸ°</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">RunLoopå›é¡¾æ€»ç»“ä¹‹ Thread-Loop Store</h1><div class="post-meta">May 8, 2018<span> | </span><span class="category"><a href="/categories/RunLoop/">RunLoop</a> -> <a href="/categories/RunLoop/Design/">è®¾è®¡</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#æ¦‚å¿µ"><span class="toc-number">1.</span> <span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ’¸ä»£ç çœ‹è®¾è®¡"><span class="toc-number">2.</span> <span class="toc-text">æ’¸ä»£ç çœ‹è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»"><span class="toc-number">2.1.</span> <span class="toc-text">RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æ ¸å¿ƒä»£ç "><span class="toc-number">2.1.1.</span> <span class="toc-text">æ ¸å¿ƒä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¾…åŠ©å‡½æ•°-TLS-æ“ä½œå‡½æ•°"><span class="toc-number">2.1.2.</span> <span class="toc-text">è¾…åŠ©å‡½æ•° - TLS æ“ä½œå‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµç¨‹å›¾"><span class="toc-number">2.1.3.</span> <span class="toc-text">æµç¨‹å›¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">2.1.4.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æœªå®Œï¼Œå¾…ç»­â€¦"><span class="toc-number">2.2.</span> <span class="toc-text">æœªå®Œï¼Œå¾…ç»­â€¦</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å¼•ç”¨"><span class="toc-number">3.</span> <span class="toc-text">å¼•ç”¨</span></a></li></ol></div></div><div class="post-content"><h1 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h1><p>ä¸€èˆ¬æ¥è¯´çº¿ç¨‹åœ¨å¤„ç†å®Œä»»åŠ¡åï¼Œå°±ä¼šç»“æŸã€‚ä¸ºäº†è®©çº¿ç¨‹å¯ä»¥æŒç»­æ¥å—ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªå¾ªç¯æ¥æŒç»­æ¥å—æ¶ˆæ¯å¹¶å¤„ç†ã€‚é€šå¸¸ç§°è¿™ä¸ªå¾ªç¯ä¸ºEventLoopï¼Œè¿™ç§æ¨¡å¼åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­æ˜¯ç±»ä¼¼çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function eventLoop() &#123;</span><br><span class="line">    initialize(); // å†…éƒ¨åˆå§‹åŒ–</span><br><span class="line">        do&#123;</span><br><span class="line">            let msg = getNextMsg(); // è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯/äº‹ä»¶</span><br><span class="line">            processMsg(msg); // æ‰§è¡Œæ¶ˆæ¯/äº‹ä»¶</span><br><span class="line">        &#125; while (msg != quit); // å¾ªç¯çŸ¥é“é€€å‡ºæ¶ˆæ¯åˆ°è¾¾</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RunLoop æ˜¯åœ¨ OSX/iOSä¸­ï¼Œè‹¹æœå¯¹EventLoopçš„ä¸€ç§å®ç°ã€‚æœ‰NSRunLoopã€CFRunLoopä¸¤ç§å¯ç”¨ã€‚å…¶ä¸­NSRunLoopæ˜¯å¯¹CFRunLoopçš„ä¸€ç§å°è£…ã€‚</p>
<h1 id="æ’¸ä»£ç çœ‹è®¾è®¡"><a href="#æ’¸ä»£ç çœ‹è®¾è®¡" class="headerlink" title="æ’¸ä»£ç çœ‹è®¾è®¡"></a>æ’¸ä»£ç çœ‹è®¾è®¡</h1><h2 id="RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»"><a href="#RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»" class="headerlink" title="RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»"></a>RunLoopä¸çº¿ç¨‹ä¹‹é—´çš„å…³ç³»</h2><p>thread - runloop æ˜¯ä¸€å¯¹ä¸€ key-value å­˜å‚¨åœ¨è¿›ç¨‹ä¸­çš„å…¨å±€Dict __CFRunLoopsä¸­ã€‚</p>
<h3 id="æ ¸å¿ƒä»£ç "><a href="#æ ¸å¿ƒä»£ç " class="headerlink" title="æ ¸å¿ƒä»£ç "></a>æ ¸å¿ƒä»£ç </h3><p><code>CFRunLoop.c line:1353</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">static pthread_t kNilPthreadT = (pthread_t)0; // åˆå§‹åŒ–  kNilPthreadT ä¸ºç©ºçº¿ç¨‹</span><br><span class="line">static CFMutableDictionaryRef __CFRunLoops = NULL; // å£°æ˜å…¨å±€çš„ä¸€ä¸ªå­—å…¸å˜é‡å¹¶åˆå§‹åŒ–ä¸ºç©ºã€‚</span><br><span class="line">static CFLock_t loopsLock = CFLockInit; // å£°æ˜ä¸€ä¸ªå…¨å±€çš„é”ï¼Œç”¨æ¥å¯¹ loops ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</span><br><span class="line"></span><br><span class="line">// è·å– runnLoop çš„å‡½æ•°ã€‚</span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) &#123;</span><br><span class="line">    if (pthread_equal(t, kNilPthreadT)) &#123;</span><br><span class="line">        t = pthread_main_thread_np();</span><br><span class="line">    &#125; // å…¥å‚çº¿ç¨‹ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨ä¸»çº¿ç¨‹ã€‚</span><br><span class="line"></span><br><span class="line">    __CFLock(&amp;loopsLock); // æ“ä½œ loops å‰åŠ é”ã€‚</span><br><span class="line"></span><br><span class="line">    if (!__CFRunLoops) &#123; // åˆ¤æ–­å…¨å±€å­—å…¸ loops æ˜¯å¦å­˜åœ¨ã€‚</span><br><span class="line">        __CFUnlock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line">    </span><br><span class="line">        CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks); // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¯å˜å­—å…¸ã€‚</span><br><span class="line">        CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np()); // åˆ›å»º mainLoopã€‚</span><br><span class="line">        CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop); // å°† mainLoop ä¸ mainThread å¯¹åº”å­˜å‚¨åœ¨ä¸´æ—¶çš„å¯å˜å­—å…¸ä¸­ã€‚</span><br><span class="line">        // å°† dict èµ‹å€¼ç»™ loopsï¼Œå†…éƒ¨æœ‰é”ã€‚</span><br><span class="line">        if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) &#123; </span><br><span class="line">            CFRelease(dict); // é‡Šæ”¾ä¸´æ—¶å˜é‡dictã€‚</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        CFRelease(mainLoop); // é‡Šæ”¾mainLoopï¼Œå› ä¸ºå·²ç»åœ¨ dict retain äº†ã€‚</span><br><span class="line">        __CFLock(&amp;loopsLock); // åŠ é”ã€‚</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); // ä» loops ä¸­è·å–çº¿ç¨‹ t çš„ loop</span><br><span class="line">    __CFUnlock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line"></span><br><span class="line">    // loops ä¸­æ²¡æœ‰çº¿ç¨‹ t çš„ loop</span><br><span class="line">    if (!loop) &#123; </span><br><span class="line">        CFRunLoopRef newLoop = __CFRunLoopCreate(t); // åˆ›å»ºçº¿ç¨‹ t çš„ loopã€‚</span><br><span class="line">        __CFLock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line">        loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); // å†æ¬¡ä» loops ä¸­è·å–çº¿ç¨‹ t çš„ loopï¼Œå‡å°ç¢°æ’å‡ ç‡ã€‚</span><br><span class="line">        // äºŒæ¬¡æ ¡éªŒ loops ä¸­æœ‰æ²¡æœ‰çº¿ç¨‹ t çš„ loopã€‚</span><br><span class="line">        if (!loop) &#123;</span><br><span class="line">            CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop); // å°†åˆ›å»ºçš„ newloop å­˜å‚¨åœ¨ loops ä¸­ã€‚</span><br><span class="line">            loop = newLoop; // èµ‹å€¼ç»™ loopã€‚</span><br><span class="line">        &#125;</span><br><span class="line">        // don&apos;t release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</span><br><span class="line">        __CFUnlock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line">        CFRelease(newLoop); // é‡Šæ”¾ newLoopã€‚</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pthread_equal(t, pthread_self())) &#123; // çº¿ç¨‹ t æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹</span><br><span class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL); // TLS(çº¿ç¨‹å±€éƒ¨å­˜å‚¨) å­˜å‚¨çº¿ç¨‹ t çš„ loopï¼Œç¨åä¼šæœ‰è¯¦ç»†ä»£ç å±•ç¤ºã€‚</span><br><span class="line">        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</span><br><span class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop); // TLS å­˜å‚¨çº¿ç¨‹é”€æ¯å’Œ loop é”€æ¯ï¼Œå®ç°çº¿ç¨‹é”€æ¯çš„æ—¶å€™ï¼Œloop ä¹Ÿé”€æ¯ã€‚</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return loop; // è¿”å›çº¿ç¨‹ t çš„ loopã€‚</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å–ä¸»çº¿ç¨‹çš„ mainLoop å‡½æ•°</span><br><span class="line">CFRunLoopRef CFRunLoopGetMain(void) &#123;</span><br><span class="line">    CHECK_FOR_FORK(); // æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦æœ‰ forkï¼Œæœ‰åˆ™é€€å‡ºã€‚</span><br><span class="line">    // åˆ›å»ºå…¨å±€å˜é‡ _mianï¼Œæ–¹ä¾¿åœ¨å…¶ä»–çº¿ç¨‹ä¸­è·å–ä¸»çº¿ç¨‹çš„ loopã€‚</span><br><span class="line">    static CFRunLoopRef __main = NULL; // no retain needed</span><br><span class="line">    // ä¸å­˜åœ¨ï¼Œåˆ™è·å–ä¸»çº¿ç¨‹çš„ mainLoopã€‚</span><br><span class="line">    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed</span><br><span class="line">    return __main;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å–å½“å‰çº¿ç¨‹çš„ loop å‡½æ•°</span><br><span class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</span><br><span class="line">    CHECK_FOR_FORK(); // æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦æœ‰ forkï¼Œæœ‰åˆ™é€€å‡ºã€‚</span><br><span class="line">    // TLS ä¸­è·å–å½“å‰çº¿ç¨‹çš„ loopã€‚</span><br><span class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    if (rl) return rl;</span><br><span class="line">    // ä¸å­˜åœ¨ï¼Œåˆ™è·å–å½“å‰çº¿ç¨‹çš„ loopã€‚</span><br><span class="line">    return _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¾…åŠ©å‡½æ•°-TLS-æ“ä½œå‡½æ•°"><a href="#è¾…åŠ©å‡½æ•°-TLS-æ“ä½œå‡½æ•°" class="headerlink" title="è¾…åŠ©å‡½æ•° - TLS æ“ä½œå‡½æ•°"></a>è¾…åŠ©å‡½æ•° - TLS æ“ä½œå‡½æ•°</h3><p><code>CFPlatform.c  line: 648</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">// å­˜å‚¨å‡½æ•°</span><br><span class="line">CF_EXPORT void *_CFSetTSD(uint32_t slot, void *newVal, tsdDestructor destructor) &#123;</span><br><span class="line">    if (slot &gt; CF_TSD_MAX_SLOTS) &#123; // å¤§äºæœ€å¤§æ§½ä¸ªæ•°ï¼Œåˆ™æŠ¥é”™</span><br><span class="line">        _CFLogSimple(kCFLogLevelError, &quot;Error: TSD slot %d out of range (set)&quot;, slot);</span><br><span class="line">        HALT;</span><br><span class="line">    &#125;</span><br><span class="line">    // è·å– TSL ä¸­çš„ table</span><br><span class="line">    __CFTSDTable *table = __CFTSDGetTable();</span><br><span class="line">    if (!table) &#123; // table ä¸å­˜åœ¨ï¼ŒæŠ¥é”™</span><br><span class="line">        // Someone is setting TSD during thread destruction. The table is gone, so we can&apos;t get any data anymore.</span><br><span class="line">        _CFLogSimple(kCFLogLevelWarning, &quot;Warning: TSD slot %d set but the thread data has already been torn down.&quot;, slot);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void *oldVal = (void *)table-&gt;data[slot]; // æŒ‰ key ä» data ä¸­è·å–ä¹‹å‰çš„å€¼</span><br><span class="line">    </span><br><span class="line">    table-&gt;data[slot] = (uintptr_t)newVal; // å­˜å‚¨æ–°å€¼</span><br><span class="line">    table-&gt;destructors[slot] = destructor; // å­˜å‚¨ææ„å™¨</span><br><span class="line">    </span><br><span class="line">    return oldVal; // è¿”å›æ•°æ®å˜æ›´ä¹‹å‰çš„å€¼</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¯»å–å‡½æ•°</span><br><span class="line">CF_EXPORT void *_CFGetTSD(uint32_t slot) &#123;</span><br><span class="line">    if (slot &gt; CF_TSD_MAX_SLOTS) &#123; // å¤§äºæœ€å¤§æ§½ä¸ªæ•°ï¼Œåˆ™æŠ¥é”™</span><br><span class="line">        _CFLogSimple(kCFLogLevelError, &quot;Error: TSD slot %d out of range (get)&quot;, slot);</span><br><span class="line">        HALT;</span><br><span class="line">    &#125;</span><br><span class="line">    // è·å– TSL ä¸­çš„ table</span><br><span class="line">    __CFTSDTable *table = __CFTSDGetTable();</span><br><span class="line">    if (!table) &#123; // table ä¸å­˜åœ¨ï¼Œåˆ™æŠ¥é”™</span><br><span class="line">        // Someone is getting TSD during thread destruction. The table is gone, so we can&apos;t get any data anymore.</span><br><span class="line">        _CFLogSimple(kCFLogLevelWarning, &quot;Warning: TSD slot %d retrieved but the thread data has already been torn down.&quot;, slot);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    uintptr_t *slots = (uintptr_t *)(table-&gt;data);</span><br><span class="line">    return (void *)slots[slot]; // æŒ‰ key ä» data ä¸­è·å–å€¼å¹¶è¿”å›</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å– TLS çš„ table</span><br><span class="line">static __CFTSDTable *__CFTSDGetTable() &#123;</span><br><span class="line">    // è·å– TLS çš„ table</span><br><span class="line">    __CFTSDTable *table = (__CFTSDTable *)__CFTSDGetSpecific();</span><br><span class="line">    // Make sure we&apos;re not setting data again after destruction.</span><br><span class="line">    if (table == CF_TSD_BAD_PTR) &#123; // è¢«ææ„äº†</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // Create table on demand</span><br><span class="line">    if (!table) &#123;</span><br><span class="line">        // This memory is freed in the finalize function</span><br><span class="line">        table = (__CFTSDTable *)calloc(1, sizeof(__CFTSDTable)); // ç”³è¯· table çš„å†…å­˜ç©ºé—´</span><br><span class="line">        pthread_key_init_np(CF_TSD_KEY, __CFTSDFinalize); // ææ„ç»‘å®š </span><br><span class="line">        __CFTSDSetSpecific(table); // å­˜å‚¨ table</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return table; //è¿”å› table</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// table è·å–å‡½æ•°</span><br><span class="line">static void *__CFTSDGetSpecific() &#123;</span><br><span class="line">    return _pthread_getspecific_direct(CF_TSD_KEY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><p><img src="../../../../images/runLoop/manageThreadLoop.png" alt="loop åˆ›å»ºæµå›¾"><br><img src="../../../../images/runLoop/getMainLoop.png" alt="mainLoop è·å–æµç¨‹"><br><img src="../../../../images/runLoop/getCurrentLoop.png" alt="currentLoop è·å–æµç¨‹"></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>Thread ä¸ RunLoop æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œä¸”å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸ä¸­ã€‚</li>
<li>ä¸»çº¿ç¨‹çš„ RunLoop æ˜¯é»˜è®¤åˆ›å»ºçš„ï¼Œå…¶ä»–çš„çº¿ç¨‹çš„ RunLoop æ˜¯ç”¨æ—¶åˆ›å»ºï¼Œæ‡’åŠ è½½çš„ã€‚</li>
<li>çº¿ç¨‹çš„ RunLoop å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½æ˜¯ä»å…¨å±€å­—å…¸ä¸­è·å–çš„ã€‚è¿™æ ·å¯ä»¥åŠ å¿«è·å–çš„è¿‡ç¨‹ï¼Œæœ‰åˆ©äºæ€§èƒ½çš„æå‡ã€‚<ul>
<li>ä¸»çº¿ç¨‹çš„ RunLoop åœ¨ç¬¬ä¸€æ¬¡æ˜¯ä»å…¨å±€å­—å…¸è·å–ï¼Œä¹‹åç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ __mainã€‚</li>
<li>å…¶ä»–çº¿ç¨‹çš„ RunLoop åœ¨ç¬¬ä¸€æ¬¡æ˜¯ä»å…¨å±€å­—å…¸è·å–ï¼Œä¹‹åç›´æ¥ä» TLS ä¸­è·å–ã€‚</li>
</ul>
</li>
</ul>
<h2 id="æœªå®Œï¼Œå¾…ç»­â€¦"><a href="#æœªå®Œï¼Œå¾…ç»­â€¦" class="headerlink" title="æœªå®Œï¼Œå¾…ç»­â€¦"></a>æœªå®Œï¼Œå¾…ç»­â€¦</h2><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><ul>
<li><a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/CF/</a></li>
<li><a href="https://blog.csdn.net/ssirreplaceable/article/details/53793456" target="_blank" rel="noopener">https://blog.csdn.net/ssirreplaceable/article/details/53793456</a></li>
<li><a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/05/18/runloop/</a></li>
<li><a href="https://blog.csdn.net/ssirreplaceable/article/details/53793456" target="_blank" rel="noopener">https://blog.csdn.net/ssirreplaceable/article/details/53793456</a></li>
<li><a href="https://stackoverflow.com/questions/47260563/whats-the-meaning-of-check-for-fork" target="_blank" rel="noopener">https://stackoverflow.com/questions/47260563/whats-the-meaning-of-check-for-fork</a></li>
</ul>
</div><iframe src="/donate/?AliPayQR=/img/AliPayQR.jpg&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=http://github.com/kangzhenpeng&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://yoursite.com/2018/05/08/RunLoopReviewSummary-TLM/" data-id="cjh301drw000axhfyc5o312tb" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACNUlEQVR42u3aQW7DMAwF0dz/0i7QVYE29nxSKSBqtAqSxtHTgiVFvl54Xd+LvPNzvfv0/lu//2bZkiFDxraM63aRTZBnvnvOu3f43mTIkHEO4z7I8oC7KnDzvcmQIUMGCYv3P0+2JUOGDBlrGcGjw42Sw5IhQ8bJDFLE8m+RI+CvF9fiMmTI2JDRD5Gfe/3B/oYMGTI2YVyl1QnBvNkQPE2GDBmjGWmxytM70rBMf+UhKMuQIWM0gw978dysNorBE1MZMmScw+DXWB1ep3xF42gyZMgYzUgbmbVrMr6VztHIkCHjHMaqfLNTmvJ25oufmQwZMrZl8CKzFmT5pRsP8XE6KEOGjEEMfgXGm46rituHfwwyZMgYzeAXXjyZq8VDcjRBgihDhoxBjHiIARe9/9MGkCFDxjmMNMCl1PRy/yNzbTJkyNiWcb/RzmBrP+zGIViGDBlDGWmilpaafUDx1lCGDBmDGLwlwLeVNi95wA2mRWTIkDGI0X9obcArGKQg4xcyZMgYzUjD7qqhsTQcy5Ah42TGVVrkIiy9vOMth4dhCxkyZIxj9ENhmjIWNxReycmQIWMSoxNqefKXFrFpqSxDhozZDL7ScpS3QmvHFANkyJCxOaNWstaGMMjR1BJNGTJknMAgiR1vc9aaCulF2x/tARkyZMgotQFIUOa/GGevMmTIOIzBR7VIWpkClqWGMmTI2JbRL2I7KSbf9ENqKEOGjKGMWt616rotLYyLABkyZOzK+ALuSx3zZWfz6QAAAABJRU5ErkJggg==">åˆ†äº«</a><div class="tags"><a href="/tags/RunLoop/">RunLoop</a><a href="/tags/Thread/">Thread</a></div><div class="post-nav"><a class="next" href="/2018/05/06/openMyBlog/">å¼€å¯æˆ‘çš„åšå®¢</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  owner: 'kangzhenpeng',
  repo: 'https://github.com/kangzhenpeng/kangzhenpeng.github.io.git',
  oauth: {
    client_id: '07853b80e09b00865a0a',
    client_secret: 'bc5c6954bfb2fb884805e1e30984be2557dcf889',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/RunLoop/">RunLoop</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/RunLoop/Design/">è®¾è®¡</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">åšå®¢åŸºç¡€</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/GitHub/" style="font-size: 15px;">GitHub</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/RunLoop/" style="font-size: 15px;">RunLoop</a> <a href="/tags/Thread/" style="font-size: 15px;">Thread</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/08/RunLoopReviewSummary-TLM/">RunLoopå›é¡¾æ€»ç»“ä¹‹ Thread-Loop Store</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/openMyBlog/">å¼€å¯æˆ‘çš„åšå®¢</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="https://blog.sunnyxx.com/" title="å­™æºå¤§ç¥çš„Blog" target="_blank">å­™æºå¤§ç¥çš„Blog</a><ul></ul><a href="https://onevcat.com/" title="ç‹å·å¤§ç¥çš„Blog" target="_blank">ç‹å·å¤§ç¥çš„Blog</a><ul></ul><a href="https://blog.ibireme.com/" title="Garan no Dou" target="_blank">Garan no Dou</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2018 <a href="/." rel="nofollow">(â—â€”â—)ğŸ°Dash.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>