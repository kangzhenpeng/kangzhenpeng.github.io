<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="ä¸€åªè¿›æ¿€çš„å¤§ç™½å…”ã€‚"><title>RunLoop å›é¡¾æ€»ç»“ | (â—â€”â—)ğŸ°Dash</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-118883756-1','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">RunLoop å›é¡¾æ€»ç»“</h1><a id="logo" href="/.">(â—â€”â—)ğŸ°Dash</a><p class="description">(â—â€”â—)åšäººåšäº‹ï¼Œèµ¢åœ¨æ ¼å±€ï¼Œè¾“åœ¨è®¡è¾ƒï¼ï¼ï¼ğŸ°</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">RunLoop å›é¡¾æ€»ç»“</h1><div class="post-meta">May 8, 2018<span> | </span><span class="category"><a href="/categories/iOS/">iOS</a> -> <a href="/categories/iOS/RunLoop/">RunLoop</a> -> <a href="/categories/iOS/RunLoop/Design/">è®¾è®¡</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#æ¦‚å¿µ"><span class="toc-number">1.</span> <span class="toc-text">æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#åº”ç”¨"><span class="toc-number">2.</span> <span class="toc-text">åº”ç”¨</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#æ¡†æ¶å›¾"><span class="toc-number">3.</span> <span class="toc-text">æ¡†æ¶å›¾</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ä»£ç åˆ†æ"><span class="toc-number">4.</span> <span class="toc-text">ä»£ç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Loop-Thread-Relation"><span class="toc-number">4.1.</span> <span class="toc-text">Loop - Thread Relation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æµç¨‹å›¾"><span class="toc-number">4.1.1.</span> <span class="toc-text">æµç¨‹å›¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ ¸å¿ƒä»£ç "><span class="toc-number">4.1.2.</span> <span class="toc-text">æ ¸å¿ƒä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¾…åŠ©ä»£ç "><span class="toc-number">4.1.3.</span> <span class="toc-text">è¾…åŠ©ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TLS-æ“ä½œå‡½æ•°"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">TLS æ“ä½œå‡½æ•°</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loop-Run"><span class="toc-number">4.2.</span> <span class="toc-text">Loop Run</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æµç¨‹å›¾-1"><span class="toc-number">4.2.1.</span> <span class="toc-text">æµç¨‹å›¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ ¸å¿ƒä»£ç -1"><span class="toc-number">4.2.2.</span> <span class="toc-text">æ ¸å¿ƒä»£ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¾…åŠ©ä»£ç -1"><span class="toc-number">4.2.3.</span> <span class="toc-text">è¾…åŠ©ä»£ç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Loop-è¿è¡Œæ•°æ®-push-pop-å‡½æ•°"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">Loop è¿è¡Œæ•°æ® push/pop å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Observer-Timer-Source-æ“ä½œå‡½æ•°"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">Observer/Timer/Source æ“ä½œå‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Block-æ“ä½œå‡½æ•°"><span class="toc-number">4.2.3.3.</span> <span class="toc-text">Block æ“ä½œå‡½æ•°</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å…³è”çŸ¥è¯†"><span class="toc-number">5.</span> <span class="toc-text">å…³è”çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Toll-Free-Bridging"><span class="toc-number">5.1.</span> <span class="toc-text">Toll-Free Bridging</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è¿›ç¨‹-çº¿ç¨‹é—´é€šä¿¡"><span class="toc-number">5.2.</span> <span class="toc-text">è¿›ç¨‹/çº¿ç¨‹é—´é€šä¿¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#çº¿ç¨‹å®‰å…¨"><span class="toc-number">5.3.</span> <span class="toc-text">çº¿ç¨‹å®‰å…¨</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#å¼•ç”¨"><span class="toc-number">6.</span> <span class="toc-text">å¼•ç”¨</span></a></li></ol></div></div><div class="post-content"><h1 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h1><p>ä¸€èˆ¬æ¥è¯´çº¿ç¨‹åœ¨å¤„ç†å®Œä»»åŠ¡åï¼Œå°±ä¼šç»“æŸã€‚ä¸ºäº†è®©çº¿ç¨‹å¯ä»¥æŒç»­æ¥å—ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªå¾ªç¯æ¥æŒç»­æ¥å—æ¶ˆæ¯å¹¶å¤„ç†ã€‚é€šå¸¸ç§°è¿™ä¸ªå¾ªç¯ä¸ºEventLoopï¼Œè¿™ç§æ¨¡å¼åœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­æ˜¯ç±»ä¼¼çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function eventLoop() &#123;</span><br><span class="line">    initialize(); // å†…éƒ¨åˆå§‹åŒ–</span><br><span class="line">        do&#123;</span><br><span class="line">            let msg = getNextMsg(); // è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯/äº‹ä»¶</span><br><span class="line">            processMsg(msg); // æ‰§è¡Œæ¶ˆæ¯/äº‹ä»¶</span><br><span class="line">        &#125; while (msg != quit); // å¾ªç¯çŸ¥é“é€€å‡ºæ¶ˆæ¯åˆ°è¾¾</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RunLoop æ˜¯åœ¨ OSX/iOSä¸­ï¼Œè‹¹æœå¯¹EventLoopçš„ä¸€ç§å®ç°ã€‚æœ‰NSRunLoopã€CFRunLoopä¸¤ç§å¯ç”¨ã€‚å…¶ä¸­NSRunLoopæ˜¯å¯¹CFRunLoopçš„ä¸€ç§å°è£…ã€‚</p>
<h1 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h1><figure><br>    <img src="http://p8pq9azjn.bkt.clouddn.com/image/runloop/RunLoopApply.png"><br></figure>

<h1 id="æ¡†æ¶å›¾"><a href="#æ¡†æ¶å›¾" class="headerlink" title="æ¡†æ¶å›¾"></a>æ¡†æ¶å›¾</h1><figure><br>    <img src="http://p8pq9azjn.bkt.clouddn.com/image/runloop/RunLoopStructureChart.png"><br></figure>

<h1 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h1><h2 id="Loop-Thread-Relation"><a href="#Loop-Thread-Relation" class="headerlink" title="Loop - Thread Relation"></a>Loop - Thread Relation</h2><ul>
<li>Thread ä¸ RunLoop æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œä¸”å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸ä¸­ã€‚</li>
<li>ä¸»çº¿ç¨‹çš„ RunLoop æ˜¯é»˜è®¤åˆ›å»ºçš„ï¼Œå…¶ä»–çº¿ç¨‹çš„ RunLoop æ˜¯ç”¨æ—¶åˆ›å»ºï¼Œæ‡’åŠ è½½çš„ã€‚</li>
<li>çº¿ç¨‹çš„ RunLoop å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½æ˜¯ä»å…¨å±€å­—å…¸ä¸­è·å–çš„ï¼Œè€Œæ˜¯ä»å…¨å±€æˆ–è€… TLS ä¸­è·å–ã€‚è¿™æ ·å¯ä»¥åŠ å¿«è·å–çš„è¿‡ç¨‹ï¼Œæœ‰åˆ©äºæ€§èƒ½çš„æå‡ã€‚<ul>
<li>ä¸»çº¿ç¨‹çš„ RunLoop åœ¨ç¬¬ä¸€æ¬¡æ˜¯ä»å…¨å±€å­—å…¸è·å–ï¼Œä¹‹åç›´æ¥ä½¿ç”¨å…¨å±€å˜é‡ __mainã€‚</li>
<li>å…¶ä»–çº¿ç¨‹çš„ RunLoop åœ¨ç¬¬ä¸€æ¬¡æ˜¯ä»å…¨å±€å­—å…¸è·å–ï¼Œä¹‹åç›´æ¥ä» TLS ä¸­è·å–ã€‚</li>
</ul>
</li>
<li>CFRunLoop ä¸­ä½¿ç”¨äº†é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚NSRunLoop æ˜¯åŸºäº CFRunLoop å°è£…çš„ï¼Œæ²¡æœ‰è®¾è®¡çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><figure><br>    <img src="http://p8pq9azjn.bkt.clouddn.com/image/runloop/ThreadLoopRelation.png"><br></figure>

<h3 id="æ ¸å¿ƒä»£ç "><a href="#æ ¸å¿ƒä»£ç " class="headerlink" title="æ ¸å¿ƒä»£ç "></a>æ ¸å¿ƒä»£ç </h3><p><code>CFRunLoop.c line:1353</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">static pthread_t kNilPthreadT = (pthread_t)0; // åˆå§‹åŒ–  kNilPthreadT ä¸ºç©ºçº¿ç¨‹</span><br><span class="line">static CFMutableDictionaryRef __CFRunLoops = NULL; // å£°æ˜å…¨å±€çš„ä¸€ä¸ªå­—å…¸å˜é‡å¹¶åˆå§‹åŒ–ä¸ºç©ºã€‚</span><br><span class="line">static CFLock_t loopsLock = CFLockInit; // å£°æ˜ä¸€ä¸ªå…¨å±€çš„é”ï¼Œç”¨æ¥å¯¹ loops ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</span><br><span class="line"></span><br><span class="line">// è·å– runnLoop çš„å‡½æ•°ã€‚</span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) &#123;</span><br><span class="line">    if (pthread_equal(t, kNilPthreadT)) &#123;</span><br><span class="line">        t = pthread_main_thread_np();</span><br><span class="line">    &#125; // å…¥å‚çº¿ç¨‹ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨ä¸»çº¿ç¨‹ã€‚</span><br><span class="line"></span><br><span class="line">    __CFLock(&amp;loopsLock); // æ“ä½œ loops å‰åŠ é”ã€‚</span><br><span class="line"></span><br><span class="line">    if (!__CFRunLoops) &#123; // åˆ¤æ–­å…¨å±€å­—å…¸ loops æ˜¯å¦å­˜åœ¨ã€‚</span><br><span class="line">        __CFUnlock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line">    </span><br><span class="line">        CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks); // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¯å˜å­—å…¸ã€‚</span><br><span class="line">        CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np()); // åˆ›å»º mainLoopã€‚</span><br><span class="line">        CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop); // å°† mainLoop ä¸ mainThread å¯¹åº”å­˜å‚¨åœ¨ä¸´æ—¶çš„å¯å˜å­—å…¸ä¸­ã€‚</span><br><span class="line">        // å°† dict èµ‹å€¼ç»™ loopsï¼Œå†…éƒ¨æœ‰é”ã€‚</span><br><span class="line">        if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) &#123; </span><br><span class="line">            CFRelease(dict); // é‡Šæ”¾ä¸´æ—¶å˜é‡dictã€‚</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        CFRelease(mainLoop); // é‡Šæ”¾mainLoopï¼Œå› ä¸ºå·²ç»åœ¨ dict retain äº†ã€‚</span><br><span class="line">        __CFLock(&amp;loopsLock); // åŠ é”ã€‚</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); // ä» loops ä¸­è·å–çº¿ç¨‹ t çš„ loop</span><br><span class="line">    __CFUnlock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line"></span><br><span class="line">    // loops ä¸­æ²¡æœ‰çº¿ç¨‹ t çš„ loop</span><br><span class="line">    if (!loop) &#123; </span><br><span class="line">        CFRunLoopRef newLoop = __CFRunLoopCreate(t); // åˆ›å»ºçº¿ç¨‹ t çš„ loopã€‚</span><br><span class="line">        __CFLock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line">        loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); // å†æ¬¡ä» loops ä¸­è·å–çº¿ç¨‹ t çš„ loopï¼Œå‡å°ç¢°æ’å‡ ç‡ã€‚</span><br><span class="line">        // äºŒæ¬¡æ ¡éªŒ loops ä¸­æœ‰æ²¡æœ‰çº¿ç¨‹ t çš„ loopã€‚</span><br><span class="line">        if (!loop) &#123;</span><br><span class="line">            CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop); // å°†åˆ›å»ºçš„ newloop å­˜å‚¨åœ¨ loops ä¸­ã€‚</span><br><span class="line">            loop = newLoop; // èµ‹å€¼ç»™ loopã€‚</span><br><span class="line">        &#125;</span><br><span class="line">        // don&apos;t release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</span><br><span class="line">        __CFUnlock(&amp;loopsLock); // è§£é”ã€‚</span><br><span class="line">        CFRelease(newLoop); // é‡Šæ”¾ newLoopã€‚</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (pthread_equal(t, pthread_self())) &#123; // çº¿ç¨‹ t æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹</span><br><span class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL); // TLS(çº¿ç¨‹å±€éƒ¨å­˜å‚¨) å­˜å‚¨çº¿ç¨‹ t çš„ loopï¼Œç¨åä¼šæœ‰è¯¦ç»†ä»£ç å±•ç¤ºã€‚</span><br><span class="line">        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</span><br><span class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop); // TLS å­˜å‚¨çº¿ç¨‹é”€æ¯å’Œ loop é”€æ¯ï¼Œå®ç°çº¿ç¨‹é”€æ¯çš„æ—¶å€™ï¼Œloop ä¹Ÿé”€æ¯ã€‚</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return loop; // è¿”å›çº¿ç¨‹ t çš„ loopã€‚</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å–ä¸»çº¿ç¨‹çš„ mainLoop å‡½æ•°</span><br><span class="line">CFRunLoopRef CFRunLoopGetMain(void) &#123;</span><br><span class="line">    CHECK_FOR_FORK(); // æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦æœ‰ forkï¼Œæœ‰åˆ™é€€å‡ºã€‚</span><br><span class="line">    // åˆ›å»ºå…¨å±€å˜é‡ _mianï¼Œæ–¹ä¾¿åœ¨å…¶ä»–çº¿ç¨‹ä¸­è·å–ä¸»çº¿ç¨‹çš„ loopã€‚</span><br><span class="line">    static CFRunLoopRef __main = NULL; // no retain needed</span><br><span class="line">    // ä¸å­˜åœ¨ï¼Œåˆ™è·å–ä¸»çº¿ç¨‹çš„ mainLoopã€‚</span><br><span class="line">    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed</span><br><span class="line">    return __main;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å–å½“å‰çº¿ç¨‹çš„ loop å‡½æ•°</span><br><span class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</span><br><span class="line">    CHECK_FOR_FORK(); // æ£€æŸ¥å½“å‰è¿›ç¨‹æ˜¯å¦æœ‰ forkï¼Œæœ‰åˆ™é€€å‡ºã€‚</span><br><span class="line">    // TLS ä¸­è·å–å½“å‰çº¿ç¨‹çš„ loopã€‚</span><br><span class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    if (rl) return rl;</span><br><span class="line">    // ä¸å­˜åœ¨ï¼Œåˆ™è·å–å½“å‰çº¿ç¨‹çš„ loopã€‚</span><br><span class="line">    return _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="è¾…åŠ©ä»£ç "><a href="#è¾…åŠ©ä»£ç " class="headerlink" title="è¾…åŠ©ä»£ç "></a>è¾…åŠ©ä»£ç </h3><h4 id="TLS-æ“ä½œå‡½æ•°"><a href="#TLS-æ“ä½œå‡½æ•°" class="headerlink" title="TLS æ“ä½œå‡½æ•°"></a>TLS æ“ä½œå‡½æ•°</h4><p><code>CFPlatform.c  line: 648</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">// å­˜å‚¨å‡½æ•°</span><br><span class="line">CF_EXPORT void *_CFSetTSD(uint32_t slot, void *newVal, tsdDestructor destructor) &#123;</span><br><span class="line">    if (slot &gt; CF_TSD_MAX_SLOTS) &#123; // å¤§äºæœ€å¤§æ§½ä¸ªæ•°ï¼Œåˆ™æŠ¥é”™</span><br><span class="line">        _CFLogSimple(kCFLogLevelError, &quot;Error: TSD slot %d out of range (set)&quot;, slot);</span><br><span class="line">        HALT;</span><br><span class="line">    &#125;</span><br><span class="line">    // è·å– TSL ä¸­çš„ table</span><br><span class="line">    __CFTSDTable *table = __CFTSDGetTable();</span><br><span class="line">    if (!table) &#123; // table ä¸å­˜åœ¨ï¼ŒæŠ¥é”™</span><br><span class="line">        // Someone is setting TSD during thread destruction. The table is gone, so we can&apos;t get any data anymore.</span><br><span class="line">        _CFLogSimple(kCFLogLevelWarning, &quot;Warning: TSD slot %d set but the thread data has already been torn down.&quot;, slot);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void *oldVal = (void *)table-&gt;data[slot]; // æŒ‰ key ä» data ä¸­è·å–ä¹‹å‰çš„å€¼</span><br><span class="line">    </span><br><span class="line">    table-&gt;data[slot] = (uintptr_t)newVal; // å­˜å‚¨æ–°å€¼</span><br><span class="line">    table-&gt;destructors[slot] = destructor; // å­˜å‚¨ææ„å™¨</span><br><span class="line">    </span><br><span class="line">    return oldVal; // è¿”å›æ•°æ®å˜æ›´ä¹‹å‰çš„å€¼</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¯»å–å‡½æ•°</span><br><span class="line">CF_EXPORT void *_CFGetTSD(uint32_t slot) &#123;</span><br><span class="line">    if (slot &gt; CF_TSD_MAX_SLOTS) &#123; // å¤§äºæœ€å¤§æ§½ä¸ªæ•°ï¼Œåˆ™æŠ¥é”™</span><br><span class="line">        _CFLogSimple(kCFLogLevelError, &quot;Error: TSD slot %d out of range (get)&quot;, slot);</span><br><span class="line">        HALT;</span><br><span class="line">    &#125;</span><br><span class="line">    // è·å– TSL ä¸­çš„ table</span><br><span class="line">    __CFTSDTable *table = __CFTSDGetTable();</span><br><span class="line">    if (!table) &#123; // table ä¸å­˜åœ¨ï¼Œåˆ™æŠ¥é”™</span><br><span class="line">        // Someone is getting TSD during thread destruction. The table is gone, so we can&apos;t get any data anymore.</span><br><span class="line">        _CFLogSimple(kCFLogLevelWarning, &quot;Warning: TSD slot %d retrieved but the thread data has already been torn down.&quot;, slot);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    uintptr_t *slots = (uintptr_t *)(table-&gt;data);</span><br><span class="line">    return (void *)slots[slot]; // æŒ‰ key ä» data ä¸­è·å–å€¼å¹¶è¿”å›</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è·å– TLS çš„ table</span><br><span class="line">static __CFTSDTable *__CFTSDGetTable() &#123;</span><br><span class="line">    // è·å– TLS çš„ table</span><br><span class="line">    __CFTSDTable *table = (__CFTSDTable *)__CFTSDGetSpecific();</span><br><span class="line">    // Make sure we&apos;re not setting data again after destruction.</span><br><span class="line">    if (table == CF_TSD_BAD_PTR) &#123; // è¢«ææ„äº†</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    // Create table on demand</span><br><span class="line">    if (!table) &#123;</span><br><span class="line">        // This memory is freed in the finalize function</span><br><span class="line">        table = (__CFTSDTable *)calloc(1, sizeof(__CFTSDTable)); // ç”³è¯· table çš„å†…å­˜ç©ºé—´</span><br><span class="line">        pthread_key_init_np(CF_TSD_KEY, __CFTSDFinalize); // ææ„ç»‘å®š </span><br><span class="line">        __CFTSDSetSpecific(table); // å­˜å‚¨ table</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return table; //è¿”å› table</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// table è·å–å‡½æ•°</span><br><span class="line">static void *__CFTSDGetSpecific() &#123;</span><br><span class="line">    return _pthread_getspecific_direct(CF_TSD_KEY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Loop-Run"><a href="#Loop-Run" class="headerlink" title="Loop Run"></a>Loop Run</h2><ul>
<li>RunLoop å®è´¨ä¸Šæ˜¯ä¸€ä¸ª doâ€¦While çš„å¾ªç¯ï¼Œé€šè¿‡ port trap æ¶ˆæ¯æ¥æ‰§è¡Œã€‚</li>
<li>RunLoop æœ‰äº”ç§è¿è¡Œ modeï¼Œæ¯ä¸ª mode ä¸­æœ‰å¤šä¸ª modeItemã€‚<ul>
<li>kCFRunLoopDefaultMode: é»˜è®¤è¿è¡Œ modeã€‚</li>
<li>UITrackingRunLoopMode: ç•Œé¢è¿½è¸ª modeï¼Œç”¨æˆ·è¿½è¸ª scrollView çš„æ»‘åŠ¨ã€‚</li>
<li>UIInitializationRunLoopMode: å¯åŠ¨åˆå§‹åŒ– modeï¼Œåªåœ¨è¯¥ mode ä¸‹è¿è¡Œä¸€æ¬¡ã€‚</li>
<li>GSEventReceiveRunLoopModeï¼šç³»ç»Ÿå†…éƒ¨äº‹ä»¶çš„ modeã€‚</li>
<li>kCFRunLoopCommonModesï¼šä¸€ä¸ªé›†åˆï¼Œé›†åˆå…¶ä»– modeã€‚</li>
<li>ModeItem: Source/Timer/Observer çš„ç»Ÿç§°ï¼Œæ²¡æœ‰å®é™…çš„æ•°æ®ç»“æ„ã€‚</li>
<li>CommonModes: æ ‡è®°ä¸º common çš„ modeï¼Œè¿™äº› mode çš„ modeItem æ˜¯ç›¸åŒçš„ã€‚å¯ä»¥ä½¿å¾— RunLoop å¯ä»¥çœ‹ä¼¼åœ¨å¤šä¸ª mode ä¸‹å…±åŒè¿è¡Œã€‚</li>
<li>CommonModeItems: common mode ä¸‹è¿è¡Œçš„äº‹ä»¶é›†åˆã€‚</li>
</ul>
</li>
<li>äº‹ä»¶ç±»å‹ï¼š<ul>
<li>Timer: ä¸ NSTimer æ˜¯ Toll-Free Bridging çš„ï¼ŒåŸºäºæ—¶é—´çš„è§¦å‘æºã€‚å¤šä¸ª Timer å¯¹åº”ä¸€ä¸ªmodeQueuePortã€‚</li>
<li>Source0: åªæœ‰ blockï¼Œæ²¡æœ‰ portï¼Œç”¨æˆ·çº§äº‹ä»¶ã€‚å¤šä¸ª source0 å¯¹åº”ä¸€ä¸ª wakeupPortï¼Œå½“ source0 è¢«æ ‡è®°åï¼Œä¼šé€šè¿‡ wakeupPort å”¤é†’æ‰§è¡Œã€‚</li>
<li>Source1: æœ‰ blok å’Œ portï¼Œç³»ç»Ÿçº§äº‹ä»¶ã€‚</li>
<li>Observer: å¯¹ loop è¿‡ç¨‹çš„ä¸€ä¸ªç›‘å¬ã€‚<ul>
<li>KCFRunLoopEntry: loop è¿›å…¥ã€‚</li>
<li>KCFRunLoopBeforeTimers: å¼€å§‹å¤„ç†Timersã€‚</li>
<li>KCFRunLoopBeforeSources: å¼€å§‹å¤„ç†Sourceã€‚</li>
<li>KCFRunLoopBeforeWaiting: å¼€å§‹ä¼‘çœ ã€‚</li>
<li>KCFRunLoopAfterWaiting: ç»“æŸä¼‘çœ ã€‚</li>
<li>KCFRunLoopExit: loop é€€å‡ºã€‚</li>
</ul>
</li>
</ul>
</li>
<li>RunLoop åœ¨å¤„ç†å®Œ source0 åå¤šç©ºè½¬ä¸€æ¬¡ï¼Œæ˜¯ä¸ºäº†ä¿è¯source0è¢«ç¡®åˆ‡çš„æ‰§è¡Œå®Œæ¯•ã€‚</li>
<li>RunLoop åªèƒ½åœ¨å•ä¸€ Mode ä¸‹è¿è¡Œï¼Œåˆ‡æ¢ mode åä¼šä¿å­˜ä¹‹å‰ mode çš„è¿è¡Œæ•°æ®ã€‚æ–° mode ä¸‹è¿è¡Œç»“æŸåï¼Œå¹¶ä¸ä¼šç»§ç»­ä¹‹å‰çš„ mode ä¸‹é‡æ–° runï¼Œä½†æ˜¯ä¼šè¿˜åŸä¹‹å‰çš„è¿è¡Œæ•°æ®ã€‚</li>
<li>RunLoop çš„ block æ˜¯ç”¨å•å‘é“¾è¡¨å­˜å‚¨çš„ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œå®Œ block çš„æ—¶å€™ä¼šå˜æ›´ä¸ºç¯å½¢é“¾è¡¨ï¼Œä¾¿äºåç»­ block æ‰§è¡Œçš„æŸ¥æ‰¾ã€‚block çŒœæµ‹æ˜¯ dispatch è¿‡æ¥çš„ã€‚</li>
<li>performâ€¦selector æœ€åå¯¹åº”çš„æ˜¯ä¸€ä¸ªå®šæ—¶å™¨äº‹ä»¶ã€‚</li>
</ul>
<h3 id="æµç¨‹å›¾-1"><a href="#æµç¨‹å›¾-1" class="headerlink" title="æµç¨‹å›¾"></a>æµç¨‹å›¾</h3><figure><br>    <img src="http://p8pq9azjn.bkt.clouddn.com/image/runloop/run.png"><br></figure>

<h3 id="æ ¸å¿ƒä»£ç -1"><a href="#æ ¸å¿ƒä»£ç -1" class="headerlink" title="æ ¸å¿ƒä»£ç "></a>æ ¸å¿ƒä»£ç </h3><p><code>CFRunLoop.c line:2649</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line">// mode åˆ‡æ¢å‡½æ•° </span><br><span class="line">SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) &#123;     /* DOES CALLOUT */</span><br><span class="line">    CHECK_FOR_FORK(); // è¿›ç¨‹æ£€æŸ¥</span><br><span class="line">    // æ£€æŸ¥loopæ˜¯å¦è¢«ææ„</span><br><span class="line">    if (__CFRunLoopIsDeallocating(rl)) return kCFRunLoopRunFinished;</span><br><span class="line">    __CFRunLoopLock(rl); // åŠ é”</span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false); // æŸ¥æ‰¾å¯¹åº” modeName çš„ mode ä¸”å¯¹ mode åŠ é”</span><br><span class="line">    // åˆ¤æ–­ mode æ˜¯å¦æœ‰æ•ˆ</span><br><span class="line">    if (NULL == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</span><br><span class="line">        Boolean did = false;</span><br><span class="line">        if (currentMode) __CFRunLoopModeUnlock(currentMode); // mode è§£é”</span><br><span class="line">        __CFRunLoopUnlock(rl); // loop è§£é”</span><br><span class="line">        return did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished; // è¿”å›è¿è¡Œç»“æœ</span><br><span class="line">    &#125;</span><br><span class="line">    volatile _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl); // è®°å½•å½“å‰ mode çš„è¿è¡Œæ•°æ®ï¼Œå¹¶å°†å½“å‰æ•°æ®ç½®ä½ï¼Œå‡†å¤‡ç»™æ–°çš„ mode ä½¿ç”¨</span><br><span class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode; // è®°å½•å½“å‰ mode</span><br><span class="line">    rl-&gt;_currentMode = currentMode; // å˜æ›´ loop çš„ mode ä¸ºç›®æ ‡ mode</span><br><span class="line">    int32_t result = kCFRunLoopRunFinished; // åˆå§‹åŒ–ä¸€ä¸ªè¿è¡Œç»“æœ</span><br><span class="line">    </span><br><span class="line">    if (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry); // å‘å‡º entry é€šçŸ¥</span><br><span class="line">    result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode); // æ‰§è¡Œ run å‡½æ•°</span><br><span class="line">    if (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit); // å‘å‡º exit é€šçŸ¥</span><br><span class="line">    </span><br><span class="line">    __CFRunLoopModeUnlock(currentMode); // mode è§£é”</span><br><span class="line">    __CFRunLoopPopPerRunData(rl, previousPerRun); // å°†è®°å½•çš„ä¹‹å‰çš„ mode çš„è¿è¡Œæ•°æ®è¿˜åŸ</span><br><span class="line">    rl-&gt;_currentMode = previousMode; // å°†è®°å½•çš„ä¹‹å‰çš„ mode è¿˜åŸ</span><br><span class="line">    __CFRunLoopUnlock(rl); // loop è§£é”</span><br><span class="line">    return result; // è¿”å›ç›®æ ‡ mode çš„è¿è¡Œç»“æœ</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Run å‡½æ•°ï¼Œå·²ç»æŠŠæ¶æ„æŒ‡ä»¤é›†é€‚é…ä»£ç ç®€åŒ–æ‰äº†</span><br><span class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    uint64_t startTSR = mach_absolute_time(); // è·å–æœºå™¨æ—¶é—´</span><br><span class="line">    </span><br><span class="line">    if (__CFRunLoopIsStopped(rl)) &#123; // åˆ¤æ–­ loop æ˜¯å¤Ÿå·²ç»åœæ­¢</span><br><span class="line">        __CFRunLoopUnsetStopped(rl); // ç½®ä½çŠ¶æ€</span><br><span class="line">        return kCFRunLoopRunStopped; // è¿”å›çŠ¶æ€</span><br><span class="line">    &#125; else if (rlm-&gt;_stopped) &#123; // å¯¹åº”çš„ mode æ˜¯å¦å·²ç»åœæ­¢</span><br><span class="line">        rlm-&gt;_stopped = false; // ç½®ä½çŠ¶æ€</span><br><span class="line">        return kCFRunLoopRunStopped; // è¿”å›çŠ¶æ€</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mach_port_name_t dispatchPort = MACH_PORT_NULL; // ç»™dispatch åˆå§‹åŒ–ä¸€ä¸ªç©ºç«¯å£</span><br><span class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ))); // åˆ¤æ–­æ˜¯å¦ç¬¬ä¸€æ¬¡é…å‘åˆ°ä¸»çº¿ç¨‹</span><br><span class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) dispatchPort = _dispatch_get_main_queue_port_4CF(); // åœ¨ä¸»çº¿ç¨‹ä¸‹ï¼Œä¼šç»™ dispatch é…ç½®ä¸€ä¸ª port</span><br><span class="line">    </span><br><span class="line">    mach_port_name_t modeQueuePort = MACH_PORT_NULL; // ç»™ modeQueue åˆå§‹åŒ–ä¸€ä¸ªç©º portï¼ŒæŸ¥çœ‹å…¨æ–‡ä»£ç ï¼Œqueue é‡Œé¢åªæ˜¯å­˜å‚¨äº† timer</span><br><span class="line">    if (rlm-&gt;_queue) &#123; // queue å­˜åœ¨</span><br><span class="line">        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue); // é…ç½®ä¸€ä¸ª port</span><br><span class="line">        if (!modeQueuePort) &#123; // é…ç½® port å¤±è´¥ï¼ŒæŠ¥é”™</span><br><span class="line">            CRASH(&quot;Unable to get port for run loop mode queue (%d)&quot;, -1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    dispatch_source_t timeout_timer = NULL; // åˆå§‹åŒ–ä¸€ä¸ªç©ºtimerï¼Œç”¨æ¥åš loop è¶…æ—¶ç›‘æµ‹çš„</span><br><span class="line">    struct __timeout_context *timeout_context = (struct __timeout_context *)malloc(sizeof(*timeout_context)); // è¶…æ—¶ä¸Šä¸‹æ–‡å†…å­˜åˆå§‹åŒ–</span><br><span class="line">    if (seconds &lt;= 0.0) &#123; // instant timeout</span><br><span class="line">        seconds = 0.0;</span><br><span class="line">        timeout_context-&gt;termTSR = 0ULL; // è¶…æ—¶æ—¶é—´ä¸º0</span><br><span class="line">    &#125; else if (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123; // åˆ¤æ–­æ˜¯å¤Ÿåœ¨é™åˆ¶æ—¶é—´é—´éš”ä¹‹å†…</span><br><span class="line">        dispatch_queue_t queue = pthread_main_np() ? __CFDispatchQueueGetGenericMatchingMain() : __CFDispatchQueueGetGenericBackground(); // æ ¹æ®çº¿ç¨‹åˆ†é…é˜Ÿåˆ—</span><br><span class="line">        timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue); // åˆ›å»ºå®šæ—¶å™¨</span><br><span class="line">        dispatch_retain(timeout_timer); // å¢åŠ å¼•ç”¨è®¡æ•°</span><br><span class="line">        // é…ç½®ä¸Šä¸‹æ–‡</span><br><span class="line">        timeout_context-&gt;ds = timeout_timer; // è®¾ç½® timer</span><br><span class="line">        timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl); // è®¾ç½® loop</span><br><span class="line">        timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds); // è®¾ç½®æ—¶é—´</span><br><span class="line">        // è®¾ç½®ä¸Šä¸‹æ–‡</span><br><span class="line">        dispatch_set_context(timeout_timer, timeout_context); // source gets ownership of context</span><br><span class="line">        // è®¾ç½®è¶…æ—¶æ“ä½œ</span><br><span class="line">        dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</span><br><span class="line">        // è®¾ç½®å–æ¶ˆæ“ä½œ</span><br><span class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</span><br><span class="line">        uint64_t ns_at = (uint64_t)((__CFTSRToTimeInterval(startTSR) + seconds) * 1000000000ULL);</span><br><span class="line">        // è®¾ç½®è¶…æ—¶å®šæ—¶å™¨</span><br><span class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(1, ns_at), DISPATCH_TIME_FOREVER, 1000ULL);</span><br><span class="line">        // å¯åŠ¨å®šæ—¶å™¨</span><br><span class="line">        dispatch_resume(timeout_timer);</span><br><span class="line">    &#125; else &#123; // infinite timeout</span><br><span class="line">        seconds = 9999999999.0; </span><br><span class="line">        timeout_context-&gt;termTSR = UINT64_MAX; // è®¾ç½®æœ€å¤§è¶…æ—¶æ—¶é—´</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Boolean didDispatchPortLastTime = true; // åˆå§‹åŒ– dispatch port çš„æ ‡è®°</span><br><span class="line">    int32_t retVal = 0; // è¿è¡Œç»“æœåˆå§‹åŒ–</span><br><span class="line">    // è¿›å…¥ä¸»ä½“äº‹ä»¶å¾ªç¯</span><br><span class="line">    do &#123;</span><br><span class="line">        voucher_mach_msg_state_t voucherState = VOUCHER_MACH_MSG_STATE_UNCHANGED;</span><br><span class="line">        voucher_t voucherCopy = NULL;</span><br><span class="line">        uint8_t msg_buffer[3 * 1024]; // åˆå§‹åŒ–ä¸€ä¸ª msg çš„ç¼“å†²</span><br><span class="line"></span><br><span class="line">        mach_msg_header_t *msg = NULL; // msg</span><br><span class="line">        mach_port_t livePort = MACH_PORT_NULL; // å½“å‰æ´»åŠ¨çš„ portï¼Œåˆå§‹åŒ–ä¸º null</span><br><span class="line">        __CFPortSet waitSet = rlm-&gt;_portSet; // å¾…ç›‘å¬çš„ port çš„é›†åˆ</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl); // è®¾ç½®å¯å”¤é†’çŠ¶æ€</span><br><span class="line">        </span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers); // é€šçŸ¥è¦å¤„ç† timers</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources); // å¤„ç†è¦å¤„ç† sources, è¿™é‡Œæ˜¯ source0</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm); // æ‰§è¡Œ blockï¼Œä»ä»£ç ä¸ŠçŒœæµ‹åº”è¯¥æ˜¯ dispatch å¡è¿›çš„ blockï¼Œä½¿ç”¨åŒå‘é“¾è¡¨ä¿å­˜</span><br><span class="line">        </span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle); // æ‰§è¡Œå¯ä»¥æ‰§è¡Œçš„ source0</span><br><span class="line">        if (sourceHandledThisLoop) &#123;</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm); // æ‰§è¡Œblock</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR); // source è¢«æ‰§è¡Œå®Œ æˆ–è€… loop è¶…æ—¶ï¼Œéœ€è¦å†ç©ºè½¬ä¸€åœˆï¼Œæ¥ä¿è¯ source0 è¢«å½»åº•æ‰§è¡Œå®Œï¼Œå› ä¸º source0 ä¸å…·å¤‡ä¸»åŠ¨å”¤é†’èƒ½åŠ›ï¼Œåªèƒ½è¢«åŠ¨æ‰§è¡Œ</span><br><span class="line">        </span><br><span class="line">        // ç¬¬ä¸€æ¬¡ä¸ä¼šæ‰§è¡Œ</span><br><span class="line">        if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123; // æ˜¯å¦æ˜¯ dispatch çš„ port </span><br><span class="line">            msg = (mach_msg_header_t *)msg_buffer; // ç¼“å†²ä¸­å– msg</span><br><span class="line">            // ç›‘å¬ port ä¸­æ¶ˆæ¯</span><br><span class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</span><br><span class="line">                goto handle_msg; // è·³è½¬åˆ°æ¶ˆæ¯æ‰§è¡Œä½“</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        didDispatchPortLastTime = false; // ç½®ä½</span><br><span class="line">        </span><br><span class="line">        // é€šçŸ¥å³å°†è¦ä¼‘çœ </span><br><span class="line">        if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">        __CFRunLoopSetSleeping(rl); // è®¾ç½® sleep çŠ¶æ€</span><br><span class="line">        // do not do any user callouts after this point (after notifying of sleeping)</span><br><span class="line">        </span><br><span class="line">        // Must push the local-to-this-activation ports in on every loop</span><br><span class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</span><br><span class="line">        // want these ports to get serviced.</span><br><span class="line">        </span><br><span class="line">        __CFPortSetInsert(dispatchPort, waitSet); // æ”¶æ•›æ‰€æœ‰çš„ port</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopModeUnlock(rlm); // è§£é” mode</span><br><span class="line">        __CFRunLoopUnlock(rl); // è§£é” loop</span><br><span class="line">        </span><br><span class="line">        CFAbsoluteTime sleepStart = poll ? 0.0 : CFAbsoluteTimeGetCurrent(); // è®°å½•ä¼‘çœ å¼€å§‹æ—¶é—´ç‚¹</span><br><span class="line">        </span><br><span class="line">        // è¿›å…¥å†…éƒ¨ç›‘å¬å¾ªç¯ä½“ï¼Œåªè¦è·³å‡ºè¯¥å¾ªç¯ä½“ï¼Œåˆ™ä»£è¡¨ loop è¢«å”¤é†’</span><br><span class="line">        do &#123;</span><br><span class="line">            if (kCFUseCollectableAllocator) &#123;</span><br><span class="line">                // objc_clear_stack(0);</span><br><span class="line">                // &lt;rdar://problem/16393959&gt;</span><br><span class="line">                memset(msg_buffer, 0, sizeof(msg_buffer)); // æ¸…ç©ºç¼“å†²åŒº</span><br><span class="line">            &#125;</span><br><span class="line">            msg = (mach_msg_header_t *)msg_buffer;</span><br><span class="line">            </span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy); // ç›‘å¬ port é›†åˆ</span><br><span class="line">            </span><br><span class="line">            // æ˜¯å¦ä¸º modeQueuePortï¼Œç”¨æ¥å¤„ç† timers </span><br><span class="line">            if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123; </span><br><span class="line">                // Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</span><br><span class="line">                while (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue)); // éå† modeQueueï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ timer åˆ°æ—¶äº†</span><br><span class="line">                // åˆ°æ—¶ï¼Œåˆ™ç½®ä½ï¼Œä¸”è·³å‡ºå†…éƒ¨å¾ªç¯ä½“</span><br><span class="line">                if (rlm-&gt;_timerFired) &#123; </span><br><span class="line">                    // Leave livePort as the queue port, and service timers below</span><br><span class="line">                    rlm-&gt;_timerFired = false; // ç½®ä½</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123; // ç»§ç»­è¯»å– msg</span><br><span class="line">                    if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123; // é modeQueuePort çš„ port msg è¢«æ•è·ï¼Œåˆ™è·³å‡ºå†…éƒ¨å¾ªç¯ä½“</span><br><span class="line">                // Go ahead and leave the inner loop.</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while (1);</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopLock(rl); // åŠ é” loop</span><br><span class="line">        __CFRunLoopModeLock(rlm); // åŠ é” mode</span><br><span class="line">        </span><br><span class="line">        rl-&gt;_sleepTime += (poll ? 0.0 : (CFAbsoluteTimeGetCurrent() - sleepStart)); // è®°å½•è‡ªå·±çš„ä¼‘çœ æ—¶é—´</span><br><span class="line">        </span><br><span class="line">        // Must remove the local-to-this-activation ports in on every loop</span><br><span class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</span><br><span class="line">        // want these ports to get serviced. Also, we don&apos;t want them left</span><br><span class="line">        // in there if this function returns.</span><br><span class="line">        </span><br><span class="line">        __CFPortSetRemove(dispatchPort, waitSet); // å°† dispatchPort ä»ç›‘å¬é›†åˆä¸­ç§»é™¤</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl); // è®¾ç½®å¿½ç•¥å”¤é†’ï¼Œå› ä¸ºå·²ç»é†’æ¥äº†</span><br><span class="line">        </span><br><span class="line">        // user callouts now OK again</span><br><span class="line">        __CFRunLoopUnsetSleeping(rl); // ç½®ä½ sleep æ ‡è®°</span><br><span class="line">        // é€šçŸ¥ç»“æŸä¼‘çœ </span><br><span class="line">        if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting); </span><br><span class="line">        </span><br><span class="line">        // æ¶ˆæ¯æ‰§è¡Œä½“</span><br><span class="line">    handle_msg:;</span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl); // è®¾ç½®å¿½ç•¥å”¤é†’ï¼Œå¯¹åº” handle_msg ä¹‹å‰çš„è®¾ç½®</span><br><span class="line">        </span><br><span class="line">        if (MACH_PORT_NULL == livePort) &#123; // æ˜¯å¦ä¸ºç©º port</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING(); // æ ‡è®°è‡ªå·±è¢«å”¤é†’çš„åŸå› æ˜¯â€œå•¥äº‹ä¹Ÿæ²¡å‘ç”Ÿâ€ï¼Œä¸€ç§å…œåº•æ–¹æ¡ˆå§</span><br><span class="line">            // handle nothing</span><br><span class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123; // æ˜¯å¦ä¸ºå”¤é†’ port </span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP(); // è¢«å”¤é†’ port å”¤é†’</span><br><span class="line">            // do nothing on Mac OS</span><br><span class="line">        &#125;</span><br><span class="line">        else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123; // æ˜¯å¦ä¸º modeQueuePort</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER(); // æ ‡è®°ä¸ºè¢« Timer äº‹ä»¶å”¤é†’</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123; // æ ¹æ®æœºå™¨äº‹ä»¶æ‰§è¡Œ timerï¼Œä½†ä¸ºæˆåŠŸ</span><br><span class="line">                // Re-arm the next timer, because we apparently fired early</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl); // å†æ¬¡æ‰§è¡Œ timer </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (livePort == dispatchPort) &#123; // æ˜¯å¦ä¸º dispatch çš„ port</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH(); // æ ‡è®°å”¤é†’çš„åŸå› æ˜¯ dispatch</span><br><span class="line">            __CFRunLoopModeUnlock(rlm); // è§£é” mode</span><br><span class="line">            __CFRunLoopUnlock(rl); // è§£é” loop</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);f</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</span><br><span class="line">            __CFRunLoopLock(rl); // åŠ é” loop</span><br><span class="line">            __CFRunLoopModeLock(rlm); // åŠ é” mode</span><br><span class="line">            sourceHandledThisLoop = true;  // æ ‡è®°æ‰§è¡Œäº† source</span><br><span class="line">            didDispatchPortLastTime = true; // æ ‡è®° dispatch çš„ port æ¢æ–°è¢«æ‰§è¡Œå®Œ</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE(); // æ ‡è®°å”¤é†’çš„åŸå› æ˜¯ source</span><br><span class="line">            </span><br><span class="line">            // If we received a voucher from this mach_msg, then put a copy of the new voucher into TSD. CFMachPortBoost will look in the TSD for the voucher. By using the value in the TSD we tie the CFMachPortBoost to this received mach_msg explicitly without a chance for anything in between the two pieces of code to set the voucher again.</span><br><span class="line">            voucher_t previousVoucher = _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, (void *)voucherCopy, os_release);</span><br><span class="line">            </span><br><span class="line">            // Despite the name, this works for windows handles as well</span><br><span class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort); // è·å–å¯¹åº” port çš„ source1</span><br><span class="line">            if (rls) &#123;</span><br><span class="line">                mach_msg_header_t *reply = NULL;</span><br><span class="line">                // æ‰§è¡Œ source1</span><br><span class="line">                sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">                if (NULL != reply) &#123;</span><br><span class="line">                    (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</span><br><span class="line">                    CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Restore the previous voucher</span><br><span class="line">            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm); // æ‰§è¡Œ block</span><br><span class="line">        </span><br><span class="line">        if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunHandledSource; // å¤„ç†å®Œäº‹ä»¶çš„è¿è¡Œç»“æœ</span><br><span class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut; // è¶…æ—¶è¿è¡Œç»“æœ</span><br><span class="line">        &#125; else if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl); // ç½®ä½</span><br><span class="line">            retVal = kCFRunLoopRunStopped; // åœæ­¢çš„è¿è¡Œç»“æœ</span><br><span class="line">        &#125; else if (rlm-&gt;_stopped) &#123; </span><br><span class="line">            rlm-&gt;_stopped = false; // ç½®ä½</span><br><span class="line">            retVal = kCFRunLoopRunStopped; // åœæ­¢çš„è¿è¡Œç»“æœ</span><br><span class="line">        &#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123; // mode å·²ç»è¢«æ‰§è¡Œå®Œäº†</span><br><span class="line">            retVal = kCFRunLoopRunFinished; // ç»“æŸçš„è¿è¡Œç»“æœ</span><br><span class="line">        &#125;</span><br><span class="line">        voucher_mach_msg_revert(voucherState);</span><br><span class="line">        os_release(voucherCopy);</span><br><span class="line">        </span><br><span class="line">    &#125; while (0 == retVal); // å¤–å±‚å¾ªç¯æ‰§è¡Œçš„æ¡ä»¶åˆ¤æ–­</span><br><span class="line">    </span><br><span class="line">    // é‡Šæ”¾è¶…æ—¶å®šæ—¶å™¨</span><br><span class="line">    if (timeout_timer) &#123;</span><br><span class="line">        dispatch_source_cancel(timeout_timer);</span><br><span class="line">        dispatch_release(timeout_timer);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        free(timeout_context);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="è¾…åŠ©ä»£ç -1"><a href="#è¾…åŠ©ä»£ç -1" class="headerlink" title="è¾…åŠ©ä»£ç "></a>è¾…åŠ©ä»£ç </h3><h4 id="Loop-è¿è¡Œæ•°æ®-push-pop-å‡½æ•°"><a href="#Loop-è¿è¡Œæ•°æ®-push-pop-å‡½æ•°" class="headerlink" title="Loop è¿è¡Œæ•°æ® push/pop å‡½æ•°"></a>Loop è¿è¡Œæ•°æ® push/pop å‡½æ•°</h4><p><code>CFRunLoop.c line:660</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// push å‡½æ•°</span><br><span class="line">CF_INLINE volatile _per_run_data *__CFRunLoopPushPerRunData(CFRunLoopRef rl) &#123;</span><br><span class="line">    volatile _per_run_data *previous = rl-&gt;_perRunData; // ä¿å­˜ä¹‹å‰çš„è¿è¡Œæ•°æ®</span><br><span class="line">    rl-&gt;_perRunData = (volatile _per_run_data *)CFAllocatorAllocate(kCFAllocatorSystemDefault, sizeof(_per_run_data), 0); // é‡æ–°åˆ›å»ºä¸€ä¸ªè¿è¡Œæ•°æ®</span><br><span class="line">    // å¯¹è¿è¡Œæ•°æ®åšåˆå§‹åŒ–ç½®ä½</span><br><span class="line">    rl-&gt;_perRunData-&gt;a = 0x4346524C;</span><br><span class="line">    rl-&gt;_perRunData-&gt;b = 0x4346524C; // &apos;CFRL&apos;</span><br><span class="line">    rl-&gt;_perRunData-&gt;stopped = 0x00000000;</span><br><span class="line">    rl-&gt;_perRunData-&gt;ignoreWakeUps = 0x00000000;</span><br><span class="line">    return previous; // è¿”å›å½“å‰çš„è¿è¡Œæ•°æ®</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// pop å‡½æ•°</span><br><span class="line">CF_INLINE void __CFRunLoopPopPerRunData(CFRunLoopRef rl, volatile _per_run_data *previous) &#123;</span><br><span class="line">    // åˆ¤æ–­å½“å‰çš„è¿è¡Œæ•°æ®æ˜¯å¦å­˜åœ¨</span><br><span class="line">    if (rl-&gt;_perRunData) CFAllocatorDeallocate(kCFAllocatorSystemDefault, (void *)rl-&gt;_perRunData // å­˜åœ¨ï¼Œåˆ™é”€æ¯</span><br><span class="line">    rl-&gt;_perRunData = previous; // åˆ‡æ¢è¿è¡Œæ•°æ®ä¸ºä¸Šä¸€æ¬¡çš„è¿è¡Œæ•°æ®</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Observer-Timer-Source-æ“ä½œå‡½æ•°"><a href="#Observer-Timer-Source-æ“ä½œå‡½æ•°" class="headerlink" title="Observer/Timer/Source æ“ä½œå‡½æ•°"></a>Observer/Timer/Source æ“ä½œå‡½æ•°</h4><p>æ“ä½œå‡½æ•°åŸºæœ¬ç±»ä¼¼ï¼Œè¿™é‡Œä»¥ observer çš„æ“ä½œä¸ºä¾‹åšä»£ç å±•å¼€ã€‚<br><code>CFRunLoop.c line:1668</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">// æ‰§è¡Œ Observer</span><br><span class="line">static void __CFRunLoopDoObservers(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopActivity activity) &#123;	/* DOES CALLOUT */</span><br><span class="line">    CHECK_FOR_FORK(); // è¿›ç¨‹ fork æ ¡éªŒ</span><br><span class="line">    </span><br><span class="line">    CFIndex cnt = rlm-&gt;_observers ? CFArrayGetCount(rlm-&gt;_observers) : 0; // observer ä¸ªæ•°è·å–</span><br><span class="line">    if (cnt &lt; 1) return; // æ²¡æœ‰åˆ™é€€å‡º</span><br><span class="line">    </span><br><span class="line">    /* Fire the observers */</span><br><span class="line">    STACK_BUFFER_DECL(CFRunLoopObserverRef, buffer, (cnt &lt;= 1024) ? cnt : 1);</span><br><span class="line">    CFRunLoopObserverRef *collectedObservers = (cnt &lt;= 1024) ? buffer : (CFRunLoopObserverRef *)malloc(cnt * sizeof(CFRunLoopObserverRef)); // åˆ›å»ºä¸€ä¸ª observer çš„é›†åˆ</span><br><span class="line">    CFIndex obs_cnt = 0;</span><br><span class="line">    for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</span><br><span class="line">        CFRunLoopObserverRef rlo = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</span><br><span class="line">        if (0 != (rlo-&gt;_activities &amp; activity) &amp;&amp; __CFIsValid(rlo) &amp;&amp; !__CFRunLoopObserverIsFiring(rlo)) &#123;</span><br><span class="line">            collectedObservers[obs_cnt++] = (CFRunLoopObserverRef)CFRetain(rlo); // å°†æœªè¢«æ‰§è¡Œçš„æœ‰æ•ˆçš„ observer ä¿å­˜åˆ° observer çš„é›†åˆä¸­</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopModeUnlock(rlm); // mode è§£é”</span><br><span class="line">    __CFRunLoopUnlock(rl); // loop è§£é”</span><br><span class="line">    for (CFIndex idx = 0; idx &lt; obs_cnt; idx++) &#123;</span><br><span class="line">        CFRunLoopObserverRef rlo = collectedObservers[idx];</span><br><span class="line">        __CFRunLoopObserverLock(rlo); // observer åŠ é”</span><br><span class="line">        if (__CFIsValid(rlo)) &#123;</span><br><span class="line">            Boolean doInvalidate = !__CFRunLoopObserverRepeats(rlo);</span><br><span class="line">            __CFRunLoopObserverSetFiring(rlo); // è®¾ç½®æ‰§è¡ŒçŠ¶æ€</span><br><span class="line">            __CFRunLoopObserverUnlock(rlo); // observer è§£é”</span><br><span class="line">            __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(rlo-&gt;_callout, rlo, activity, rlo-&gt;_context.info); // æ‰§è¡Œ observer</span><br><span class="line">            if (doInvalidate) &#123;</span><br><span class="line">                CFRunLoopObserverInvalidate(rlo); // è®¾ç½®å¤±æ•ˆçŠ¶æ€</span><br><span class="line">            &#125;</span><br><span class="line">            __CFRunLoopObserverUnsetFiring(rlo); // æ¸…é™¤æ‰§è¡ŒçŠ¶æ€</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            __CFRunLoopObserverUnlock(rlo); // observer è§£é”</span><br><span class="line">        &#125;</span><br><span class="line">        CFRelease(rlo);</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopLock(rl); // loop åŠ é”</span><br><span class="line">    __CFRunLoopModeLock(rlm); // mode åŠ é”</span><br><span class="line">    </span><br><span class="line">    if (collectedObservers != buffer) free(collectedObservers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// æ·»åŠ  observer</span><br><span class="line">void CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef rlo, CFStringRef modeName) &#123;</span><br><span class="line">    CHECK_FOR_FORK(); // è¿›ç¨‹ fork æ ¡éªŒ</span><br><span class="line">    CFRunLoopModeRef rlm;</span><br><span class="line">    if (__CFRunLoopIsDeallocating(rl)) return; // loop ææ„çš„æ—¶å€™é€€å‡º</span><br><span class="line">    if (!__CFIsValid(rlo) || (NULL != rlo-&gt;_runLoop &amp;&amp; rlo-&gt;_runLoop != rl)) return; // observer å’Œ loop æ ¡éªŒ </span><br><span class="line">    __CFRunLoopLock(rl); // loop åŠ é”</span><br><span class="line">    if (modeName == kCFRunLoopCommonModes) &#123; // common æ ‡è®°çš„ mode çš„å¤„ç†</span><br><span class="line">        // è·å– common æ ‡è®°çš„ mode çš„é›†åˆ</span><br><span class="line">        CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</span><br><span class="line">        // è·å– common æ ‡è®°çš„ modeItem çš„é›†åˆ</span><br><span class="line">        if (NULL == rl-&gt;_commonModeItems) &#123;</span><br><span class="line">            rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</span><br><span class="line">        &#125;</span><br><span class="line">        // å°† observer æ·»åŠ åˆ° common æ ‡è®°çš„ modeItem çš„é›†åˆä¸­</span><br><span class="line">        CFSetAddValue(rl-&gt;_commonModeItems, rlo);</span><br><span class="line">        if (NULL != set) &#123;</span><br><span class="line">            CFTypeRef context[2] = &#123;rl, rlo&#125;;</span><br><span class="line">            /* add new item to all common-modes */</span><br><span class="line">            CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</span><br><span class="line">            CFRelease(set);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        rlm = __CFRunLoopFindMode(rl, modeName, true); // æŸ¥è¯¢ mode</span><br><span class="line">        // observer çš„é›†åˆæ ¡éªŒï¼Œä¸ºç©ºåˆ™åˆ›å»º</span><br><span class="line">        if (NULL != rlm &amp;&amp; NULL == rlm-&gt;_observers) &#123;</span><br><span class="line">            rlm-&gt;_observers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeArrayCallBacks);</span><br><span class="line">        &#125;</span><br><span class="line">        // æŸ¥è¯¢ observer æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ </span><br><span class="line">        if (NULL != rlm &amp;&amp; !CFArrayContainsValue(rlm-&gt;_observers, CFRangeMake(0, CFArrayGetCount(rlm-&gt;_observers)), rlo)) &#123;</span><br><span class="line">            Boolean inserted = false;</span><br><span class="line">            for (CFIndex idx = CFArrayGetCount(rlm-&gt;_observers); idx--; ) &#123;</span><br><span class="line">                CFRunLoopObserverRef obs = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</span><br><span class="line">                if (obs-&gt;_order &lt;= rlo-&gt;_order) &#123;</span><br><span class="line">                    CFArrayInsertValueAtIndex(rlm-&gt;_observers, idx + 1, rlo);</span><br><span class="line">                    inserted = true;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            // ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ </span><br><span class="line">            if (!inserted) &#123;</span><br><span class="line">                CFArrayInsertValueAtIndex(rlm-&gt;_observers, 0, rlo);</span><br><span class="line">            &#125;</span><br><span class="line">            rlm-&gt;_observerMask |= rlo-&gt;_activities;</span><br><span class="line">            __CFRunLoopObserverSchedule(rlo, rl, rlm); // å¯¹ observer ä¸­çš„è®°å½•çš„ loop count åšå˜æ›´</span><br><span class="line">        &#125;</span><br><span class="line">        if (NULL != rlm) &#123;</span><br><span class="line">            __CFRunLoopModeUnlock(rlm); // mode è§£é”</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopUnlock(rl); // loop è§£é”</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ç§»é™¤ observer</span><br><span class="line">void CFRunLoopRemoveObserver(CFRunLoopRef rl, CFRunLoopObserverRef rlo, CFStringRef modeName) &#123;</span><br><span class="line">    CHECK_FOR_FORK(); // è¿›ç¨‹ fork æ ¡éªŒ</span><br><span class="line">    CFRunLoopModeRef rlm;</span><br><span class="line">    __CFRunLoopLock(rl); // loop åŠ é”</span><br><span class="line">    if (modeName == kCFRunLoopCommonModes) &#123; // æ˜¯å¦ä¸º common æ ‡è®°çš„ mode </span><br><span class="line">        // common æ ‡è®°çš„ mode é›†åˆä¸­æ˜¯å¦å­˜åœ¨ç›®æ ‡ observer</span><br><span class="line">        if (NULL != rl-&gt;_commonModeItems &amp;&amp; CFSetContainsValue(rl-&gt;_commonModeItems, rlo)) &#123;</span><br><span class="line">            CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</span><br><span class="line">            CFSetRemoveValue(rl-&gt;_commonModeItems, rlo); // ä» common æ ‡è®°çš„ modeItem çš„é›†åˆä¸­ç§»é™¤ç›®æ ‡ observer</span><br><span class="line">            if (NULL != set) &#123;</span><br><span class="line">                CFTypeRef context[2] = &#123;rl, rlo&#125;;</span><br><span class="line">                /* remove new item from all common-modes */</span><br><span class="line">                CFSetApplyFunction(set, (__CFRunLoopRemoveItemFromCommonModes), (void *)context);</span><br><span class="line">                CFRelease(set);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        rlm = __CFRunLoopFindMode(rl, modeName, false); // æŸ¥è¯¢ mode</span><br><span class="line">        // observer é›†åˆæ ¡éªŒ</span><br><span class="line">        if (NULL != rlm &amp;&amp; NULL != rlm-&gt;_observers) &#123;</span><br><span class="line">            CFRetain(rlo);</span><br><span class="line">            CFIndex idx = CFArrayGetFirstIndexOfValue(rlm-&gt;_observers, CFRangeMake(0, CFArrayGetCount(rlm-&gt;_observers)), rlo); // æŸ¥æ‰¾ observer </span><br><span class="line">            if (kCFNotFound != idx) &#123;</span><br><span class="line">                CFArrayRemoveValueAtIndex(rlm-&gt;_observers, idx);</span><br><span class="line">                __CFRunLoopObserverCancel(rlo, rl, rlm); // å˜æ›´ observer ä¸­è®°å½•çš„ loop count </span><br><span class="line">            &#125;</span><br><span class="line">            CFRelease(rlo);</span><br><span class="line">        &#125;</span><br><span class="line">        if (NULL != rlm) &#123;</span><br><span class="line">            __CFRunLoopModeUnlock(rlm); // mode è§£é”</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopUnlock(rl); // loop è§£é”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Block-æ“ä½œå‡½æ•°"><a href="#Block-æ“ä½œå‡½æ•°" class="headerlink" title="Block æ“ä½œå‡½æ•°"></a>Block æ“ä½œå‡½æ•°</h4><p><code>CFRunLoop.c line:1618</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">// æ‰§è¡Œ block å‡½æ•°</span><br><span class="line">static Boolean __CFRunLoopDoBlocks(CFRunLoopRef rl, CFRunLoopModeRef rlm) &#123; // Call with rl and rlm locked</span><br><span class="line">    // blocks é“¾è¡¨æ ¡éªŒ</span><br><span class="line">    if (!rl-&gt;_blocks_head) return false;</span><br><span class="line">    // mode æ ¡éªŒ</span><br><span class="line">    if (!rlm || !rlm-&gt;_name) return false;</span><br><span class="line">    Boolean did = false;</span><br><span class="line">    // è·å–é“¾è¡¨çš„è¡¨å¤´</span><br><span class="line">    struct _block_item *head = rl-&gt;_blocks_head;</span><br><span class="line">    // è·å–é“¾è¡¨çš„è¡¨å°¾</span><br><span class="line">    struct _block_item *tail = rl-&gt;_blocks_tail;</span><br><span class="line">    rl-&gt;_blocks_head = NULL;</span><br><span class="line">    rl-&gt;_blocks_tail = NULL;</span><br><span class="line">    CFSetRef commonModes = rl-&gt;_commonModes;</span><br><span class="line">    CFStringRef curMode = rlm-&gt;_name;</span><br><span class="line">    __CFRunLoopModeUnlock(rlm);</span><br><span class="line">    __CFRunLoopUnlock(rl);</span><br><span class="line">    struct _block_item *prev = NULL;</span><br><span class="line">    struct _block_item *item = head; // ä»å¤´å¼€å§‹éå†</span><br><span class="line">    while (item) &#123;</span><br><span class="line">        struct _block_item *curr = item;</span><br><span class="line">        item = item-&gt;_next;</span><br><span class="line">        Boolean doit = false;</span><br><span class="line">        // æ ¡éªŒæ˜¯å¦æ‰§è¡Œ</span><br><span class="line">        if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</span><br><span class="line">            doit = CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</span><br><span class="line">        &#125;</span><br><span class="line">        // ä¸æ‰§è¡Œï¼Œåˆ™è¿˜åŸ</span><br><span class="line">        if (!doit) prev = curr;</span><br><span class="line">        // æ‰§è¡Œï¼Œåˆ™ç»§ç»­å‘åéå†</span><br><span class="line">        if (doit) &#123;</span><br><span class="line">            // å˜æ›´é“¾è¡¨çš„å¤´å°¾</span><br><span class="line">            if (prev) prev-&gt;_next = item;</span><br><span class="line">            if (curr == head) head = item;</span><br><span class="line">            if (curr == tail) tail = prev;</span><br><span class="line">            void (^block)(void) = curr-&gt;_block;</span><br><span class="line">            CFRelease(curr-&gt;_mode);</span><br><span class="line">            free(curr);</span><br><span class="line">            // æ‰§è¡Œ block</span><br><span class="line">            if (doit) &#123;</span><br><span class="line">                __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);</span><br><span class="line">                did = true;</span><br><span class="line">            &#125;</span><br><span class="line">            Block_release(block); // do this before relocking to prevent deadlocks where some yahoo wants to run the run loop reentrantly from their dealloc</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line">    __CFRunLoopModeLock(rlm);</span><br><span class="line">    // ç¯å½¢é“¾è¡¨å˜æ›´</span><br><span class="line">    if (head) &#123;</span><br><span class="line">        tail-&gt;_next = rl-&gt;_blocks_head;</span><br><span class="line">        rl-&gt;_blocks_head = head;</span><br><span class="line">        if (!rl-&gt;_blocks_tail) rl-&gt;_blocks_tail = tail;</span><br><span class="line">    &#125;</span><br><span class="line">    return did;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// block å­˜å‚¨å‡½æ•°</span><br><span class="line">void CFRunLoopPerformBlock(CFRunLoopRef rl, CFTypeRef mode, void (^block)(void)) &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    // mode ç±»å‹çš„åˆ¤æ–­</span><br><span class="line">    if (CFStringGetTypeID() == CFGetTypeID(mode)) &#123;</span><br><span class="line">        mode = CFStringCreateCopy(kCFAllocatorSystemDefault, (CFStringRef)mode);</span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        // ensure mode exists</span><br><span class="line">        CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)mode, true); // æŸ¥è¯¢ modeï¼Œæ²¡æœ‰åˆ™åˆ›å»º</span><br><span class="line">        if (currentMode) __CFRunLoopModeUnlock(currentMode);</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line">    &#125; else if (CFArrayGetTypeID() == CFGetTypeID(mode)) &#123;</span><br><span class="line">        CFIndex cnt = CFArrayGetCount((CFArrayRef)mode);</span><br><span class="line">        const void **values = (const void **)malloc(sizeof(const void *) * cnt);</span><br><span class="line">        CFArrayGetValues((CFArrayRef)mode, CFRangeMake(0, cnt), values);</span><br><span class="line">        mode = CFSetCreate(kCFAllocatorSystemDefault, values, cnt, &amp;kCFTypeSetCallBacks);</span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        // ensure modes exist</span><br><span class="line">        for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</span><br><span class="line">            CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)values[idx], true);</span><br><span class="line">            if (currentMode) __CFRunLoopModeUnlock(currentMode);</span><br><span class="line">        &#125;</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line">        free(values);</span><br><span class="line">    &#125; else if (CFSetGetTypeID() == CFGetTypeID(mode)) &#123;</span><br><span class="line">        CFIndex cnt = CFSetGetCount((CFSetRef)mode);</span><br><span class="line">        const void **values = (const void **)malloc(sizeof(const void *) * cnt);</span><br><span class="line">        CFSetGetValues((CFSetRef)mode, values);</span><br><span class="line">        mode = CFSetCreate(kCFAllocatorSystemDefault, values, cnt, &amp;kCFTypeSetCallBacks);</span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        // ensure modes exist</span><br><span class="line">        for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</span><br><span class="line">            CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)values[idx], true);</span><br><span class="line">            if (currentMode) __CFRunLoopModeUnlock(currentMode);</span><br><span class="line">        &#125;</span><br><span class="line">        __CFRunLoopUnlock(rl);</span><br><span class="line">        free(values);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mode = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    block = Block_copy(block);</span><br><span class="line">    // æ ¡éªŒ mode å’Œ block</span><br><span class="line">    if (!mode || !block) &#123;</span><br><span class="line">        if (mode) CFRelease(mode);</span><br><span class="line">        if (block) Block_release(block);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line">    // é“¾è¡¨èŠ‚ç‚¹åˆ›å»ºï¼Œè¡¨å°¾æ·»åŠ </span><br><span class="line">    struct _block_item *new_item = (struct _block_item *)malloc(sizeof(struct _block_item));</span><br><span class="line">    new_item-&gt;_next = NULL;</span><br><span class="line">    new_item-&gt;_mode = mode;</span><br><span class="line">    new_item-&gt;_block = block;</span><br><span class="line">    if (!rl-&gt;_blocks_tail) &#123;</span><br><span class="line">        rl-&gt;_blocks_head = new_item;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        rl-&gt;_blocks_tail-&gt;_next = new_item;</span><br><span class="line">    &#125;</span><br><span class="line">    rl-&gt;_blocks_tail = new_item;</span><br><span class="line">    __CFRunLoopUnlock(rl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å…³è”çŸ¥è¯†"><a href="#å…³è”çŸ¥è¯†" class="headerlink" title="å…³è”çŸ¥è¯†"></a>å…³è”çŸ¥è¯†</h1><h2 id="Toll-Free-Bridging"><a href="#Toll-Free-Bridging" class="headerlink" title="Toll-Free Bridging"></a>Toll-Free Bridging</h2><ul>
<li>Toll-Free Bridging æ˜¯æŒ‡åœ¨å¤šä¸ªæ¡†æ¶ä¸­æ•°æ®ç±»å‹å¯ä»¥æ— ç¼åˆ‡æ¢ã€‚åœ¨ iOS ä¸­æ˜¯æŒ‡ CoreFoundation å’Œ Foundation ä¸¤ä¸ªæ¡†æ¶ä¹‹é—´æ•°æ®ç±»å‹çš„è½¬æ¢ã€‚</li>
<li>ä¸æ˜¯æ‰€æœ‰è€…ä¸¤ä¸ªæ¡†æ¶ä¸­çš„æ•°æ®ç±»å‹éƒ½å¯ä»¥ç›¸äº’è½¬æ¢ã€‚ä»¥ä¸‹æ˜¯ä¸èƒ½ç›¸äº’è½¬æ¢çš„<ul>
<li>NSRunLoop å’Œ CFRunLoop </li>
<li>NSBundle å’Œ CFBundle</li>
<li>NSDateFormatter å’Œ CFDateFormatter</li>
</ul>
</li>
<li>MRC ä¸‹ä¸æ¶‰åŠå†…å­˜ç®¡ç†çš„è½¬ç§»ï¼Œå¯ä»¥ç›´æ¥è½¬æ¢ã€‚</li>
<li>ARC ä¸‹æ¶‰åŠå†…å­˜ç®¡ç†çš„è½¬ç§»ï¼Œåœ¨è½¬æ¢æ—¶éœ€è¦æŒ‡å®šå†…å­˜ç®¡ç†çš„æ‰€æœ‰æƒã€‚<ul>
<li>__bridge: ä¸æ”¹å˜å†…å­˜ç®¡ç†æ–¹å¼ã€‚<ul>
<li>CF -&gt; F: F çš„å†…å­˜ç”±ç¼–è¯‘å™¨ç®¡ç†ï¼ŒCF çš„å†…å­˜ç®¡ç†ç”±å¼€å‘è€…ç®¡ç†ã€‚</li>
<li>F -&gt; CF: F çš„å†…å­˜ç”±ç¼–è¯‘å™¨ç®¡ç†ï¼ŒCF æ²¡æœ‰è¢« retainï¼Œä¸éœ€è¦å¤„ç†ã€‚</li>
</ul>
</li>
<li><strong>bridge_reatained: è§£å†³ </strong>bridge ä¸‹ F -&gt; CF æ—¶ï¼ŒF è¢«é‡Šæ”¾ï¼ŒCF ä¹Ÿå°±è¢«é‡Šæ”¾ï¼Œå†ä½¿ç”¨å°±ä¼šå‡ºç°å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚<ul>
<li>F çš„å†…å­˜æœ‰ç¼–è¯‘å™¨ç®¡ç†ï¼ŒCF ä¼šè¢«ç¼–è¯‘å™¨ retainï¼Œå†…å­˜éœ€è¦ç”±å¼€å‘è€…ç®¡ç†ã€‚</li>
<li>ç”±äº CF è¢« retainï¼Œå†ä½¿ç”¨å°±ä¸ä¼šå‡ºç° __bridge æ— æ³•è§£å†³çš„å†…å­˜æ³„æ¼é—®é¢˜äº†ã€‚</li>
</ul>
</li>
<li><strong>bridge_transfer: è§£å†³ </strong>bridge ä¸‹ CF -&gt; F æ—¶ï¼Œå¤æ‚çš„ä¸­é—´å˜é‡å’Œ CF çš„å†…å­˜ç®¡ç†é—®é¢˜è€Œåšçš„ç®€åŒ–å¤„ç†ã€‚<ul>
<li>F çš„å†…å­˜ç”±ç¼–è¯‘å™¨ç®¡ç†</li>
<li>CF çš„å†…å­˜ç”±ç¼–è¯‘å™¨è½¬ç§»äº†ï¼Œå¼€å‘è€…ä¸éœ€è¦å†å¤„ç†ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="è¿›ç¨‹-çº¿ç¨‹é—´é€šä¿¡"><a href="#è¿›ç¨‹-çº¿ç¨‹é—´é€šä¿¡" class="headerlink" title="è¿›ç¨‹/çº¿ç¨‹é—´é€šä¿¡"></a>è¿›ç¨‹/çº¿ç¨‹é—´é€šä¿¡</h2><ul>
<li>çº¿ç¨‹é—´ä½¿ç”¨ NSPort é€šä¿¡ </li>
<li>è¿›ç¨‹é—´ä½¿ç”¨ NSTask é€šä¿¡</li>
</ul>
<h2 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h2><ul>
<li>å¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºäº§ç”Ÿç«æ€æ¡ä»¶ï¼Œå³ä¼šå¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</li>
<li>å¤šå‘ç”Ÿåœ¨å†™æ“ä½œæ—¶äº§ç”Ÿçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</li>
<li>å®¹æ˜“å¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜çš„èµ„æºï¼š<ul>
<li>å…±äº«èµ„æº</li>
<li>å±€éƒ¨å¯¹è±¡å¼•ç”¨ï¼šå¯¹è±¡æ”¾åœ¨å…±äº«å †ä¸­ï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå¼•ç”¨æ˜¯ä¸è¢«å…±äº«çš„ã€‚<code>å±€éƒ¨å˜é‡ä¸ä¼šå¼•èµ·çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå­˜æ”¾åœ¨çº¿ç¨‹çš„æ ˆä¸­ã€‚</code></li>
<li>æ–‡ä»¶ã€æ•°æ®åº“</li>
</ul>
</li>
<li>é€šè¿‡åŠ é”æ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</li>
</ul>
<h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><ul>
<li><a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">æºç </a></li>
<li><a href="https://blog.csdn.net/ssirreplaceable/article/details/53793456" target="_blank" rel="noopener">å…³äºRunLoopéƒ¨åˆ†æºç çš„æ³¨é‡Š</a></li>
<li><a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">æ·±å…¥ç†è§£RunLoop</a></li>
<li><a href="http://blog.gocy.tech/2016/09/03/runloop-source-reading/" target="_blank" rel="noopener">RunLoopå­¦ä¹ ç¬”è®°</a></li>
<li><a href="https://www.jianshu.com/p/ec629063390f" target="_blank" rel="noopener">è€å¸æœºå‡ºå“â€”â€”æºç è§£æä¹‹RunLoopè¯¦è§£</a></li>
<li><a href="https://stackoverflow.com/questions/47260563/whats-the-meaning-of-check-for-fork" target="_blank" rel="noopener">Check_For_Fork</a></li>
<li><a href="https://www.jianshu.com/p/c53f2eb116ae" target="_blank" rel="noopener">Toll-Free Bridging</a></li>
<li><a href="https://blog.csdn.net/yxh265/article/details/51483822" target="_blank" rel="noopener">iOSçº¿ç¨‹é€šä¿¡å’Œè¿›ç¨‹é€šä¿¡çš„ä¾‹å­</a></li>
<li><a href="https://www.jianshu.com/p/4c50e04c82c7" target="_blank" rel="noopener">iOS-çº¿ç¨‹å®‰å…¨æ¢ç©¶</a></li>
</ul>
</div><iframe src="/donate/?AliPayQR=/img/AliPayQR.jpg&amp;WeChatQR=/img/WeChatQR.jpg&amp;GitHub=http://github.com/kangzhenpeng&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://yoursite.com/2018/05/08/RunLoopReviewSummary/" data-id="cjhhqzhje000r0vf32sb5gdzn" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACNUlEQVR42u3a207DQAxF0f7/TweJ1zCTfey0os6epwrStCtIxrfXC5/j96xen8/+yvNvV9fcfGTIkPG1jGN7+tesvjR/1/4aGTJkPIdBguzqFmkY7QTl5c9lyJAhoxQE9ySeUMqQIUNGn5EG6No9ZciQIaNTgvJHsE8BP1SLy5Ah4wsZ/cHA+15/dL4hQ4aMf8k4wsODJg/NaZH8x7eSIUPGaEatgNxHPD6w5Ei0kCFDhozRDJJr1W7KFylua7rJkCFjHIN/AG+x8UWKdMy5LHdlyJAxmnHXakX6IGpBGQViGTJkjGN0mmv9EMyT0YsHJEOGjNEMnpzxwFpbpEgHnMu/iQwZMkYz0lwyLYDTIjZdAZEhQ8ZsBg9w6boYX9EgX5GksDJkyJjH6KxW8CL2fWMAGTJkPI1Ra8DdFYKDYvV8NxkyZDyAEcw5G8GUvIs36dAIU4YMGYMYZA2i1phLh6P8sy4mGzJkyBjHqBWQvNBNE8000MuQIWM2o1aUpkGWJ4vpA72Yb8iQIWMEg69K8LCYpom19FSGDBnPZPBkjlzffwRBKStDhozRjH6jP1326hwUpmXIkDGOcYSHp4AkNPMgexGyZciQMZrRb/Tzm3YacLURggwZMiYx+ApF2ixLEz4+WkCZowwZMsYx0gbZ/l28VZf+B4h33GTIkPEwRmc80C+PZciQISNltNYjSve/uF6GDBkPYNQWLFI2b9XFJbQMGTJGM2qDgfctVdRSTxkyZAxl/AC1llvRMxxyfAAAAABJRU5ErkJggg==">åˆ†äº«</a><div class="tags"><a href="/tags/iOS/">iOS</a><a href="/tags/RunLoop/">RunLoop</a><a href="/tags/Thread/">Thread</a></div><div class="post-nav"><a class="pre" href="/2018/05/15/RunLoop-AutoreleasePool/">AutoreleasePool å›é¡¾æ€»ç»“</a><a class="next" href="/2018/05/06/openMyBlog/">å¼€å¯æˆ‘çš„åšå®¢</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  id: 'cjhhqzhje000r0vf32sb5gdzn',
  owner: 'kangzhenpeng',
  repo: 'kangzhenpeng.github.io',
  oauth: {
    client_id: '07853b80e09b00865a0a',
    client_secret: 'bc5c6954bfb2fb884805e1e30984be2557dcf889',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/RunLoop/">RunLoop</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/RunLoop/Apply/">åº”ç”¨</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/RunLoop/Design/">è®¾è®¡</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">åšå®¢åŸºç¡€</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/autorelease/" style="font-size: 15px;">autorelease</a> <a href="/tags/autoreleasePool/" style="font-size: 15px;">autoreleasePool</a> <a href="/tags/iOS/" style="font-size: 15px;">iOS</a> <a href="/tags/RunLoop/" style="font-size: 15px;">RunLoop</a> <a href="/tags/CADisplayLink/" style="font-size: 15px;">CADisplayLink</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/GitHub/" style="font-size: 15px;">GitHub</a> <a href="/tags/Blog/" style="font-size: 15px;">Blog</a> <a href="/tags/Thread/" style="font-size: 15px;">Thread</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/18/iOS-RunLoop-Apply-CADisplayLink/">CADisplayLink å›é¡¾æ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/RunLoop-AutoreleasePool/">AutoreleasePool å›é¡¾æ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/08/RunLoopReviewSummary/">RunLoop å›é¡¾æ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/06/openMyBlog/">å¼€å¯æˆ‘çš„åšå®¢</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="https://blog.sunnyxx.com/" title="å­™æºå¤§ç¥çš„Blog" target="_blank">å­™æºå¤§ç¥çš„Blog</a><ul></ul><a href="https://onevcat.com/" title="ç‹å·å¤§ç¥çš„Blog" target="_blank">ç‹å·å¤§ç¥çš„Blog</a><ul></ul><a href="https://blog.ibireme.com/" title="Garan no Dou" target="_blank">Garan no Dou</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2018 <a href="/." rel="nofollow">(â—â€”â—)ğŸ°Dash.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>